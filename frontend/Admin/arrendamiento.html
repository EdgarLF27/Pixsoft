<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arrendamiento de Equipos - Pixsoft</title>
    <link href="../src/output.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            background-image:
                radial-gradient(at 0% 0%, rgba(93, 173, 226, 0.05) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(133, 193, 226, 0.05) 0px, transparent 50%);
            background-attachment: fixed;
        }

        .tab-active {
            border-bottom: 2px solid #5DADE2;
            color: #5DADE2;
            font-weight: 600;
        }

        .tab-inactive {
            color: #64748b;
        }

        .tab-inactive:hover {
            color: #1e293b;
        }

        .spec-row:nth-child(odd) {
            background-color: #f9fafb;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="h-screen overflow-hidden flex text-sm">

    <!-- Sidebar -->
    <aside
        class="w-64 glass-sidebar flex flex-col h-full fixed md:relative z-50 transition-transform -translate-x-full md:translate-x-0"
        id="sidebar">
        <!-- Logo -->
        <div class="h-20 flex items-center px-8 border-b border-white/5">
            <div class="flex items-center gap-3">
                <div class="relative w-8 h-8 flex items-center justify-center">
                    <span
                        class="text-3xl font-bold text-transparent bg-clip-text bg-linear-to-br from-[#5DADE2] to-[#85C1E2]"
                        style="font-family: sans-serif;">P</span>
                </div>
                <span class="text-xl font-bold text-slate-900 tracking-wide">PIXSOFT</span>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 overflow-y-auto py-6 px-4 space-y-2">
            <a href="index.html"
                class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:text-slate-900 hover:bg-slate-100 transition-all group">
                <i class="fa-solid fa-chart-line w-5 group-hover:text-[#5DADE2] transition-colors"></i>
                Dashboard
            </a>
            <a href="productos.html"
                class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:text-slate-900 hover:bg-slate-100 transition-all group">
                <i class="fa-solid fa-box-open w-5 group-hover:text-[#5DADE2] transition-colors"></i>
                Productos
            </a>
            <a href="arrendamiento.html"
                class="flex items-center gap-3 px-4 py-3 rounded-xl bg-linear-to-r from-[#5DADE2]/20 to-transparent text-[#5DADE2] border border-[#5DADE2]/20 font-medium transition-all">
                <i class="fa-solid fa-file-contract w-5"></i>
                Arrendamientos
            </a>
            <a href="#"
                class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:text-slate-900 hover:bg-slate-100 transition-all group">
                <i class="fa-solid fa-users w-5 group-hover:text-[#5DADE2] transition-colors"></i>
                Clientes
            </a>
            <div class="pt-4 pb-2">
                <p class="px-4 text-xs font-semibold text-slate-500 uppercase tracking-wider">Sistema</p>
            </div>
            <a href="#"
                class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:text-slate-900 hover:bg-slate-100 transition-all group">
                <i class="fa-solid fa-gear w-5 group-hover:text-[#5DADE2] transition-colors"></i>
                Configuración
            </a>
        </nav>

        <!-- User Profile -->
        <div class="p-4 border-t border-white/5">
            <div class="flex items-center gap-3 px-4 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 transition-colors cursor-pointer"
                onclick="logout()">
                <img src="https://ui-avatars.com/api/?name=Admin+User&background=5DADE2&color=fff" alt="Admin"
                    class="w-8 h-8 rounded-full">
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-slate-900 truncate" id="user-name">Administrador</p>
                    <p class="text-xs text-slate-500 truncate" id="user-email">admin@pixsoft.com</p>
                </div>
                <i class="fa-solid fa-right-from-bracket text-xs text-slate-400"></i>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full overflow-hidden relative">
        <!-- Mobile Header -->
        <header class="md:hidden h-16 flex items-center justify-between px-4 glass-panel z-40">
            <button id="menu-btn" class="text-slate-600 hover:text-slate-900">
                <i class="fa-solid fa-bars text-xl"></i>
            </button>
            <span class="font-bold text-slate-900">PIXSOFT Arrendamiento</span>
            <div class="w-8"></div> <!-- Spacer -->
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth">

            <!-- Tabs de Categorías -->
            <div class="mb-8">
                <div class="border-b border-slate-200">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button onclick="switchTab('computers')" id="tab-computers"
                            class="tab-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm flex items-center">
                            <i data-lucide="laptop" class="w-4 h-4 mr-2"></i> Computadoras
                        </button>
                        <button onclick="switchTab('servers')" id="tab-servers"
                            class="tab-inactive whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm flex items-center">
                            <i data-lucide="server" class="w-4 h-4 mr-2"></i> Servidores y Redes
                        </button>
                        <button onclick="switchTab('printing')" id="tab-printing"
                            class="tab-inactive whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm flex items-center">
                            <i data-lucide="printer" class="w-4 h-4 mr-2"></i> Impresión
                        </button>
                        <button onclick="switchTab('contracts')" id="tab-contracts"
                            class="tab-inactive whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm flex items-center ml-auto text-[#5DADE2]">
                            <i data-lucide="file-text" class="w-4 h-4 mr-2"></i> Mis Contratos
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Contenido: Catálogo de Productos -->
            <div id="catalog-view" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Las tarjetas de productos se inyectarán aquí -->
                <div class="col-span-full text-center py-12 text-slate-500">Cargando equipos...</div>
            </div>

            <!-- Contenido: Mis Contratos -->
            <div id="contracts-view" class="hidden">
                <div
                    class="bg-white/90 backdrop-blur-md shadow-lg overflow-hidden sm:rounded-xl border border-slate-200">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-slate-600 uppercase tracking-wider">
                                    ID</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-slate-600 uppercase tracking-wider">
                                    Equipo</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-slate-600 uppercase tracking-wider">
                                    Periodo</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-slate-600 uppercase tracking-wider">
                                    Estado</th>
                                <th
                                    class="px-6 py-3 text-right text-xs font-medium text-slate-600 uppercase tracking-wider">
                                    Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="contracts-list" class="bg-white divide-y divide-slate-200">
                            <!-- Contratos inyectados aquí -->
                        </tbody>
                    </table>
                </div>
            </div>

        </div>

        </div>
    </main>

    <!-- Modal de Cotización y Contrato -->
    <div id="quote-modal" class="fixed inset-0 bg-slate-900 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 overflow-hidden border border-slate-200">
            <div class="px-6 py-4 bg-linear-to-r from-[#5DADE2] to-[#34D399] flex justify-between items-center">
                <h3 class="text-lg font-medium text-white" id="modal-title">Configurar Arrendamiento</h3>
                <button onclick="closeModal()" class="text-white hover:text-slate-100 transition-colors"><i
                        data-lucide="x" class="w-5 h-5"></i></button>
            </div>

            <div class="p-6">
                <div class="flex gap-6">
                    <!-- Columna Izquierda: Info Producto -->
                    <div class="w-1/3 border-r border-slate-200 pr-6">
                        <h4 class="font-bold text-slate-900 text-lg mb-2" id="modal-product-name">Nombre Equipo</h4>
                        <p class="text-sm text-slate-600 mb-4" id="modal-product-desc">Descripción...</p>

                        <div class="bg-slate-50 p-3 rounded-lg text-xs space-y-1" id="modal-product-specs">
                            <!-- Specs -->
                        </div>
                    </div>

                    <!-- Columna Derecha: Formulario -->
                    <div class="w-2/3 space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700">Periodo de Arrendamiento</label>
                            <select id="modal-period"
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-2 focus:ring-[#5DADE2] focus:border-[#5DADE2] sm:text-sm rounded-lg border">
                                <option value="DAILY">Diario</option>
                                <option value="WEEKLY">Semanal</option>
                                <option value="MONTHLY">Mensual</option>
                                <option value="ANNUAL" selected>Anual</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700">Inicio</label>
                                <input type="date" id="modal-start"
                                    class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-[#5DADE2] focus:border-[#5DADE2] sm:text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700">Fin</label>
                                <input type="date" id="modal-end"
                                    class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-[#5DADE2] focus:border-[#5DADE2] sm:text-sm">
                            </div>
                        </div>

                        <div class="flex items-center">
                            <input id="modal-maintenance" type="checkbox"
                                class="h-4 w-4 text-[#5DADE2] focus:ring-[#5DADE2] border-slate-300 rounded">
                            <label for="modal-maintenance" class="ml-2 block text-sm text-slate-900">
                                Incluir Mantenimiento y Seguro (+10%)
                            </label>
                        </div>

                        <div id="quote-summary"
                            class="bg-linear-to-r from-[#5DADE2]/10 to-[#34D399]/10 p-4 rounded-lg border border-[#5DADE2]/20 hidden">
                            <div class="flex justify-between text-sm font-medium text-slate-900">
                                <span>Costo Total Estimado:</span>
                                <span id="modal-total-cost" class="text-lg font-bold text-[#5DADE2]">$0.00</span>
                            </div>
                            <p class="text-xs text-slate-600 mt-1" id="modal-duration-text"></p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="px-6 py-4 bg-slate-50 flex justify-end space-x-3">
                <button type="button" onclick="calculateQuote()"
                    class="px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-[#5DADE2] bg-[#5DADE2]/10 hover:bg-[#5DADE2]/20 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#5DADE2] transition-all">
                    Cotizar
                </button>
                <button type="button" id="btn-create-contract" onclick="createContract()" disabled
                    class="px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-linear-to-r from-[#34D399] to-[#5DADE2] hover:from-[#2DD98C] hover:to-[#4FA0D5] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#34D399] disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-lg shadow-[#34D399]/20">
                    Generar Contrato
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Firma -->
    <div id="sign-modal" class="fixed inset-0 bg-slate-900 bg-opacity-50 hidden items-center justify-center z-50">
        <div
            class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full mx-4 overflow-hidden flex flex-col max-h-[90vh] border border-slate-200">
            <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center">
                <h3 class="text-lg font-medium text-slate-900">Firma de Contrato</h3>
                <button onclick="document.getElementById('sign-modal').classList.add('hidden')"
                    class="text-slate-400 hover:text-slate-600 transition-colors"><i data-lucide="x"
                        class="w-5 h-5"></i></button>
            </div>

            <div class="p-6 overflow-y-auto flex-1">
                <div class="prose prose-sm max-w-none bg-slate-50 p-4 border border-slate-200 rounded-lg mb-4">
                    <h4 class="text-center font-bold mb-4 text-slate-900">CONTRATO DE ARRENDAMIENTO DE EQUIPO
                        TECNOLÓGICO</h4>
                    <pre id="contract-text" class="whitespace-pre-wrap font-mono text-xs text-slate-700"></pre>
                </div>

                <div class="border-t border-slate-200 pt-4">
                    <label class="block text-sm font-medium text-slate-700 mb-2">Firma Digital (Escriba su nombre
                        completo para aceptar)</label>
                    <input type="text" id="signature-input" placeholder="Yo, [Nombre Completo], acepto los términos..."
                        class="block w-full border border-slate-300 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-[#5DADE2] focus:border-[#5DADE2] sm:text-sm">
                    <p class="text-xs text-slate-500 mt-1">Al escribir su nombre y hacer clic en Firmar, acepta
                        legalmente los términos y condiciones expuestos arriba.</p>
                </div>
            </div>

            <div class="px-6 py-4 bg-slate-50 flex justify-end space-x-3">
                <button type="button" onclick="submitSignature()"
                    class="px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-linear-to-r from-[#5DADE2] to-[#34D399] hover:from-[#4FA0D5] hover:to-[#2DD98C] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#5DADE2] transition-all shadow-lg shadow-[#5DADE2]/30">
                    Firmar Digitalmente
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Configuración y Estado ---
        const API_BASE = "http://localhost:8000/api/v1/leasing/";
        let allProducts = [];
        let currentCategory = 'computers';
        let currentQuote = null;
        let activeContractId = null;

        // --- Inicialización ---
        window.onload = async () => {
            if (window.lucide) lucide.createIcons();
            checkAuth();
            await loadProducts();
            setupDates();
        };

        function checkAuth() {
            const token = localStorage.getItem('accessToken');
            const statusEl = document.getElementById('auth-status');
            if (!token) {
                statusEl.textContent = "No autenticado";
                statusEl.classList.add('text-red-500');
                // Opcional: Redirigir a setup_auth.html si se desea forzar
            } else {
                statusEl.textContent = "Sesión Activa";
                statusEl.classList.add('text-green-600');
            }
        }

        function logout() {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            window.location.href = '../Login.html';
        }

        function setupDates() {
            const today = new Date().toISOString().split('T')[0];
            const nextYear = new Date();
            nextYear.setFullYear(nextYear.getFullYear() + 1);

            document.getElementById('modal-start').value = today;
            document.getElementById('modal-end').value = nextYear.toISOString().split('T')[0];
        }

        // --- API Helper ---
        async function apiCall(endpoint, method = 'GET', body = null) {
            const token = localStorage.getItem('accessToken');
            const headers = { 'Content-Type': 'application/json' };
            if (token) headers['Authorization'] = `Bearer ${token}`;

            try {
                const res = await fetch(API_BASE + endpoint, {
                    method, headers, body: body ? JSON.stringify(body) : null
                });

                if (res.status === 401) {
                    alert("Sesión expirada. Por favor ingrese nuevamente.");
                    window.location.href = '../Login.html';
                    return null;
                }

                if (!res.ok) throw new Error(await res.text());
                return res.status === 204 ? true : await res.json();
            } catch (e) {
                console.error("API Error:", e);
                alert("Error: " + e.message);
                return null;
            }
        }

        // --- Lógica de UI ---
        async function loadProducts() {
            const data = await apiCall('products/');
            if (data) {
                allProducts = data;
                renderCatalog();
            }
        }

        function switchTab(tab) {
            // Actualizar estilos de tabs
            ['computers', 'servers', 'printing', 'contracts'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                if (t === tab) {
                    btn.className = "tab-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm flex items-center";
                } else {
                    btn.className = "tab-inactive whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm flex items-center";
                }
            });

            if (tab === 'contracts') {
                document.getElementById('catalog-view').classList.add('hidden');
                document.getElementById('contracts-view').classList.remove('hidden');
                loadContracts();
            } else {
                document.getElementById('catalog-view').classList.remove('hidden');
                document.getElementById('contracts-view').classList.add('hidden');
                currentCategory = tab;
                renderCatalog();
            }
        }

        function renderCatalog() {
            const container = document.getElementById('catalog-view');
            container.innerHTML = '';

            // Mapeo de categorías del backend a tabs del frontend
            const categoryMap = {
                'computers': 'Computadoras Portátiles y de Escritorio',
                'servers': 'Servidores y Equipos de Red',
                'printing': 'Equipos de Impresión y Digitalización'
            };

            const filtered = allProducts.filter(p => p.category_name === categoryMap[currentCategory]);

            if (filtered.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-12 text-slate-400">No hay equipos disponibles en esta categoría.</div>`;
                return;
            }

            filtered.forEach(p => {
                // Renderizar especificaciones
                let specsHtml = '';
                if (p.specifications) {
                    Object.entries(p.specifications).slice(0, 4).forEach(([k, v]) => {
                        specsHtml += `<div class="flex justify-between text-xs text-slate-600 mb-1"><span>${k}:</span> <span class="font-medium">${v}</span></div>`;
                    });
                }

                const card = document.createElement('div');
                card.className = "bg-white/90 backdrop-blur-md overflow-hidden shadow-lg rounded-2xl border border-slate-200 hover:shadow-xl hover:border-[#5DADE2]/30 transition-all duration-300 hover:-translate-y-1";
                card.innerHTML = `
                    <div class="px-4 py-5 sm:p-6">
                        <h3 class="text-lg leading-6 font-medium text-slate-900 truncate">${p.name}</h3>
                        <p class="mt-1 max-w-2xl text-sm text-slate-600 h-10 overflow-hidden">${p.description}</p>
                        
                        <div class="mt-4 bg-slate-50 p-3 rounded-lg border border-slate-200">
                            ${specsHtml}
                        </div>

                        <div class="mt-5">
                            <button onclick='openQuoteModal(${JSON.stringify(p).replace(/'/g, "&#39;")})' class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-lg shadow-[#5DADE2]/20 text-sm font-medium text-white bg-gradient-to-r from-[#5DADE2] to-[#34D399] hover:from-[#4FA0D5] hover:to-[#2DD98C] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#5DADE2] transition-all">
                                Cotizar Arrendamiento
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- Cotización ---
        let selectedProduct = null;

        function openQuoteModal(product) {
            selectedProduct = product;
            document.getElementById('modal-product-name').textContent = product.name;
            document.getElementById('modal-product-desc').textContent = product.description;

            // Render specs en modal
            const specsContainer = document.getElementById('modal-product-specs');
            specsContainer.innerHTML = '';
            if (product.specifications) {
                Object.entries(product.specifications).forEach(([k, v]) => {
                    specsContainer.innerHTML += `<div class="flex justify-between border-b border-gray-200 pb-1 last:border-0"><span>${k}</span> <span class="font-semibold">${v}</span></div>`;
                });
            }

            document.getElementById('quote-summary').classList.add('hidden');
            document.getElementById('btn-create-contract').disabled = true;
            document.getElementById('quote-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('quote-modal').classList.add('hidden');
        }

        async function calculateQuote() {
            const payload = {
                product_id: selectedProduct.id,
                period: document.getElementById('modal-period').value,
                start_date: document.getElementById('modal-start').value,
                end_date: document.getElementById('modal-end').value
            };

            const data = await apiCall('quote/', 'POST', payload);
            if (data) {
                currentQuote = data;

                // Aplicar recargo de mantenimiento si está seleccionado (simulado en frontend por simplicidad visual, idealmente en backend)
                let cost = parseFloat(data.total_cost);
                if (document.getElementById('modal-maintenance').checked) {
                    cost *= 1.10; // +10%
                }

                document.getElementById('modal-total-cost').textContent = `$${cost.toFixed(2)}`;
                document.getElementById('modal-duration-text').textContent = `Duración: ${data.duration_days} días`;
                document.getElementById('quote-summary').classList.remove('hidden');
                document.getElementById('btn-create-contract').disabled = false;
            }
        }

        async function createContract() {
            if (!currentQuote) return;

            let finalCost = parseFloat(currentQuote.total_cost);
            if (document.getElementById('modal-maintenance').checked) {
                finalCost *= 1.10;
            }

            const payload = {
                product: selectedProduct.id,
                plan: currentQuote.plan_id,
                start_date: document.getElementById('modal-start').value,
                end_date: document.getElementById('modal-end').value,
                total_cost: finalCost,
                contract_document: currentQuote.contract_document,
                is_signed: false,
                status: 'PENDING'
            };

            const res = await apiCall('contracts/', 'POST', payload);
            if (res) {
                alert(`Contrato #${res.id} generado exitosamente.`);
                closeModal();
                switchTab('contracts');
            }
        }

        // --- Contratos ---
        async function loadContracts() {
            const list = document.getElementById('contracts-list');
            list.innerHTML = '<tr><td colspan="5" class="text-center py-4">Cargando...</td></tr>';

            const data = await apiCall('contracts/');
            list.innerHTML = '';

            if (!data || data.length === 0) {
                list.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-slate-500">No tienes contratos activos.</td></tr>';
                return;
            }

            data.forEach(c => {
                const tr = document.createElement('tr');
                const statusColor = c.is_signed ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                const statusText = c.is_signed ? 'Firmado / Activo' : 'Pendiente de Firma';

                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">#${c.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${c.product_name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${c.plan_period}</td>
                    <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">${statusText}</span></td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        ${!c.is_signed ? `<button onclick="openSignModal(${c.id}, '${encodeURIComponent(c.contract_document)}')" class="text-[#5DADE2] hover:text-[#34D399] transition-colors">Firmar</button>` : '<span class="text-slate-400">Firmado</span>'}
                    </td>
                `;
                list.appendChild(tr);
            });
        }

        function openSignModal(id, docEncoded) {
            activeContractId = id;
            document.getElementById('contract-text').textContent = decodeURIComponent(docEncoded);
            document.getElementById('signature-input').value = '';
            document.getElementById('sign-modal').classList.remove('hidden');
        }

        async function submitSignature() {
            const sig = document.getElementById('signature-input').value;
            if (sig.trim().length < 5) {
                alert("Por favor escriba su nombre completo para firmar.");
                return;
            }

            const res = await apiCall(`contracts/${activeContractId}/`, 'PATCH', {
                is_signed: true,
                status: 'ACTIVE'
            });

            if (res) {
                alert("Contrato firmado correctamente.");
                document.getElementById('sign-modal').classList.add('hidden');
                loadContracts();
            }
        }

        // Mobile menu toggle
        const menuBtn = document.getElementById('menu-btn');
        const sidebar = document.getElementById('sidebar');

        if (menuBtn) {
            menuBtn.addEventListener('click', () => {
                sidebar.classList.toggle('-translate-x-full');
            });
        }

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', (e) => {
            if (window.innerWidth < 768) {
                if (!sidebar.contains(e.target) && !menuBtn.contains(e.target)) {
                    sidebar.classList.add('-translate-x-full');
                }
            }
        });

    </script>
</body>

</html>